<!--
DocType: Memo
Audience: Designer / Programmer / LLM
WhenToRead: 「未知×発見」を核にしたMVP（サンドボックス）検証計画を固めるとき
Stability: draft
-->

# Discovery MVP 制作案（未知×発見を核にした縦スライス）

作成日: 2025-12-20

## 0. 目的（North Star）

本プロジェクトの「未知×発見」を、ターン制グリッド上で **“面倒さ” ではなく “気持ちよさ（発見と再利用）”** として成立させるための MVP 制作案。

- 伝統的ローグライクの戦利品更新（良い武器/防具/エンチャントで高tierへ）
- 素材/タグ/環境相互作用により「戦い方・突破の仕方が変わる」
- 重量（ソフト制限）と加工（現地↔拠点/作業台）で意思決定が生まれる

この束が回ることを、まずは **検証用サンドボックス空間**で確かめる。 

参照: v1 North Star / 検証ポイント 
- 「タグが義務にならない（DPS相性表に寄せない / 再現性 / 工夫で得）」
- 「拾う→試す→選ぶ（重量超過デバフ＋逃げ道）」
- 「戦利品更新と素材ループの役割分担」
## 1. MVP の定義（この MVP が答える問い）

この MVP が答えるべき最重要の問いは次の3つ。

1) タグ/素材/環境相互作用は **義務化せず**、プレイヤーに「工夫すると得（安全/効率/突破）」を提供できるか
2) 重量（ソフト制限）は **試行錯誤を殺さず**、欲張り・撤退・現地加工の「判断」を生めるか
3) 戦利品更新（装備）と素材ループが **競合せず**、役割分担して同じプレイ内で回るか

> 重要: ここでいう “未知” は「生成が毎回違う」だけではなく、
> - 情報が隠れている（FoW / 観測）
> - 見つけた因果が資産化する（再現性 / ログ / 保存）
> が満たされて初めて成立する。

## 2. スコープ（今回やる / やらない）

### 2.1 今回やる（必須）

**0. 恒常の能動手段（BotWのルーン相当）**
- 「火を起こしたいのに火種がない」「液体を試したいのに運べない」を、設計上の欠乏で潰さない。
- MVPでは次を **“常備前提（再入手容易）”** として扱う（欠乏で試行錯誤が止まらないようにする）。
  - 火打ち石（着火の起点）
  - 空の容器（液体を運ぶ/投げるの起点）
- どちらも **アイテムとして扱う**（捨てる/投げるは可能）。紛失しても再入手できる前提で、世界に普遍的に流通させる。
  - 火打ち石: 重量0（暫定）。消耗はしない。
  - 容器: 容器自体は重量0（暫定）だが、**中身によって重量が増減**する設計へ接続できるようにする。
- ねらい: 発見・再現のループを、資源枯渇ではなく「判断（TU/危険/重量/位置）」で成立させる。

**A. ルール付きゾーン生成（seedあり）**
- “CoQ風”のゾーン生成を参考にするが、まずは「試せる」ことを最優先。
- シード値で決定的に生成できる（再現/デバッグ用）。
- ゾーン生成は **保証配置**（下記 3.2）を持つ。

**B. タグの磨き込み（少数で深く）**
- タグは火力相性表ではなく、状況/行動の質を変える方向。
- チェックリスト（入口/出口/観測/再現性/AI反応/摩擦）を DoD として運用。

**C. 宝箱（チェスト）からの“タグ付き武器”排出**
- 武器種は 1 種でよい。
- ただし武器個体にはタグ/挙動差（状況操作の手段）が付与される。
- チェストの出現場所（暫定）:
  - モンスターキャンプ（焚き火）付近、または建物跡地の内側に高確率で置かれる
  - 追加分の寄せ先は「キャンプ70% / 跡地30%」（seedで決定）

**D. ログ強化（観測と学習の資産化）**
- 状態変化ログ（必須）
- 「何が起きたか」が追える（プレイヤー向け）
- 「なぜ起きたか」まで追える（Dev Only のデバッグ観測: RULE ID / 内部タグ等）
- 敵種別の学習（MVP）:
  - 敵を観測/戦闘するほど、ホバー/Inspect に「行動傾向」「次の行動（確度つき）」などの整理された情報が追加される。
  - 発見の明示ログ（`DISCOVERED:` 等）は不要（方針: 5.2）。

**E. 素材ループ（入手→投擲→結果、素材×環境の変質）**
- 例: 土→投擲→遮蔽/汚染/足止め 等、分かりやすい結果
- 例: 土×水→泥（変質）

**F. 重量（ソフト制限）＋逃げ道**
- 超過でデバフ（TU/回避など体感に直結）。
- 捨てる/仮置き/預ける/圧縮（最小は「捨てる」でOK）

**G. FoW（未知の成立）＋ Inspect（調べる）**
- 未探索/探索済み視界外/視界内 の 3 状態
- 調べる（Inspect）:
  - タイル/敵/アイテムのスプライトと説明文を表示する
  - 対象のタグ一覧を表示し、タグはツールチップ等で「意味」を確認できるようにする
  - P1候補: スカウター等の装備で「中身/所持品」など追加情報を閲覧できる余地を残す（P0では表示しない）
- ホバー/ターゲット（ミニInspect）:
  - ターン消費なしで「最小の観測」を行う入口（フルInspectは詳細確認用）。
  - 敵の場合は、敵種別学習（上記D）に応じて「行動傾向」「次の行動（確度つき）」などを簡潔に表示できる。

### 2.2 今回やらない（後回し）

- 無限地上チャンクストリーミングの最適化（必要になってから）
- 大量の敵・大量のバイオーム・派閥/ロアの本格導入
- 高度クラフト（キャンプ/作業台の本格化）
- 属性付与エンチャントの広範囲展開（まずは“状況操作”の核を優先）

## 3. MVP を 2層に分ける（ラボ + 実戦）

「未知×発見」を検証するため、同じコードベースを2つの運用（Dev Only / 本編）で回す。

注意: ラボ（検証環境）は **開発用（Dev Only）**であり、ゲーム本編に登場させることは想定しない。  
プレイヤーが触れるのは実戦（Discovery Vertical Slice）側のみとする。

### 3.1 Layer-1: ラボ（検証環境）

目的: タグ/RULE/素材相互作用を **短手順で再現**し、観測と調整を高速に回す。

最低要件:
- 任意の素材/武器/敵/地形をスポーンできる（デバッグUIまたはコマンド）
- Dev Only のデバッグ観測が読みやすい（RULE ID 等で原因→結果が追える）
- 状態可視化（タイル/ユニットの現在タグが確認できる）

### 3.2 Layer-2: 実戦（Discovery Vertical Slice）

目的: 生成・FoW・宝箱・重量の圧がある状況で、タグが義務化せず「得」になるかを確認する。

**保証配置（ゾーン生成の DoD）**
- 1ゾーン内に最低限、以下が必ず存在する
  - 素材: 2種以上（例: 土、水源）
  - 反応先: 反応が起きる地形/タイル（例: 水場、可燃物、導電床などのうち1つ）
  - 宝箱: 1個以上
  - 敵: 1〜2種（最小でOK）
  - 安全な退路: 迂回できる通路 or 撤退できる出口

（Discovery MVP 向けの具体セット案）
- 1ゾーン（80×25想定）の「保証配置」を、次のランドマークで具体化する（暫定）:
  - 木: `tree_normal` のまとまり（可燃物の入口）
  - 水辺: `ground_normal` + `overlay_water` のまとまり（水への退避・消火・wetの入口）
  - モンスターキャンプ: 火源（焚き火相当）＋敵が集まっている配置
  - 建物の跡地: 外周の壁だけが残った区画（瓦礫/崩落の雰囲気）
  - チェスト: キャンプ付近 or 建物跡地に高確率で配置（最低1個は保証）
  - ダンジョン入口: 下り階段（例: `Ash-and-Circuit/Assets/_Project/Art/Tiles/Interior/Stair_down.png` 相当）
  - 退路: 迂回できる通路を最低1本（P0では「出口タイル」より先に確保する）

補足（実装メモ / 範囲外ハンドリング）:
- 現状の `MapManager.Get...` の範囲外（out-of-bounds）挙動は既存方針を踏襲する（例: `GetTileType` は `GroundNormal` を返す等）。
- マップ生成ルール（境界仕様）を SoT として確定する段階で、範囲外の扱いをまとめて見直す（要チケット）。

## 4. 最小コンテンツセット（例）

> 具体の名前は仮。重要なのは「入口が容易」「結果が分かる」「再現できる」。

### 4.0 恒常ツール（常備）

- 火打ち石（常備前提）: 火を起こすための起点。消耗品にしない（試行錯誤を阻害しないため）。
  - アイテムとして扱い、捨てる/投げるは可能。ただし世界に普遍的に流通し、再入手できる前提とする。
  - 重量: 0（暫定）
- 空の容器（常備前提）: 液体を運ぶ/投げるための起点。消耗品にしない。
  - アイテムとして扱い、捨てる/投げるは可能。再入手できる前提とする。
  - 容器自体の重量: 0（暫定）
  - 中身: リソース（重量・回数）として扱ってよい（中身に応じて総重量が変動する設計に接続）

### 4.1 素材（3〜5個）

- 土（投擲で “遮蔽/足止め/汚染” のいずれかを確実に起こす）
- 水（濡らす/消火/導電の入口）
- 油（燃焼の入口、滑り/移動阻害など）
- 火種（着火の入口）
  - 注: 着火の「起点」は恒常ツール（火打ち石）で担保し、火種アイテムは増幅・応用側に回す（例: 松明の維持、特殊着火、燃料）。

### 4.2 環境タイル（4〜6個）

- 通常床 / 壁
- 水場（wet の入口）
- 可燃物タイル（flammable）
- 導電床（conductive）

### 4.3 タグ（2〜4個、まずは少数）

- `wet`
- `oily`
- `burning`
- `conductive`

**注意:** 1状況で同時に意識させるタグ数は 2〜3 を上限目標。

### 4.4 武器（ベース1種 + タグ差分）

- ベース: 近接 or 遠隔のどちらか（現状の戦闘/命中判定に合わせる）
- 個体差: 「火力差」よりも
  - 射程/精度/特殊挙動（跳弾/貫通/拡散）
  - 状態付与（確率より条件成立で再現）
  - “状況を変える”効果（地形を濡らす/油を撒く など）

### 4.5 敵（最小1〜2種）

- 役割が異なる敵を用意する（例: 突進型 / 遠隔型）
- AI反応（回避/迂回/消火など）を最低1つ持たせる

## 5. ログ/観測（MVPの中核）

### 5.1 戦闘ログ（必須）
- プレイヤー向け:
  - ターン番号や Actor 名の明示は原則しない（必要な場合のみ **8方位**等で補助する）。
  - 継続状態語（例:「燃えている」「濡れている」）は基本書かず、視覚で伝える。
  - ログは「何が起きた？」/「なぜ起きた？」（直接原因のみ）を補うときだけ出す。
  - 視界外の出来事を“耳”で拾う表現は MVP では扱わない。
  - 例: 「油を踏んで滑って転倒した！」 / 「油に火が着いた！」 / 「水たまりに飛び込み、鎮火した！」
- Dev Only:
  - 必要に応じてターン番号・対象識別・RULE ID・内部タグ等を出してよい（ただし `DISCOVERED:` 等で発見を強調しない）。

### 5.2 「発見」の明示はしない（方針）

「新しく発見した！」のように、発見そのものを明示するログは出さない。  
また、プレイヤー向けログでタグやルールの説明を行わない（説明しすぎない）。

代わりに、プレイヤーが「何が起きたか」を把握できる手がかりを **ログ＋エフェクト＋AI反応**の 3 点で設計する。

- ログ（プレイヤー向け）:
  - 継続状態の説明（例: 「燃えている」「濡れている」）は原則として書かず、視覚で伝える。
  - 視覚だけだと取りこぼす「何が起きた？」/「なぜ起きた？」を、短文で補う。
    - 例: 「油を踏んで滑って転倒した！」
    - 例: 「油に火が着いた！」
    - 例: 「ゴブリンは水たまりに飛び込み、鎮火した！」
  - ターン番号や Actor 名の明示は原則しない（必要なら **8方位**で補助する: 「北東のゴブリンが…」）。
- エフェクト（見た目）:
  - 重要な状態変化（引火/燃焼/変質/付与/解除）は、タイル/ユニットの見た目で分かる変化を伴わせる（スプライト差分、簡易パーティクル等）。
- AI反応:
  - 危険や有利不利がある場合、敵がそれに対して「避ける/迂回する/退避する」などの反応を示し、結果を観測できるようにする（最低1つでよい）。

Dev Only のデバッグ観測では、RULE ID / 内部タグ等の追跡情報を出してよい。  
ただし「初回発火＝発見」を強調する専用表示（`DISCOVERED:` 等）は不要とし、必要なら内部計測に留める。

補足（MVP）:
- 視界外の出来事を“耳”で拾う表現は、MVPでは扱わない（必要になった時点で別途設計する）。

### 5.3 Inspect（必須）
- 表示:
  - 対象のスプライトと説明文
  - 対象のタグ一覧（タグ名＋ツールチップ等で意味を確認できる）
- ミニInspect（ホバー/ターゲット固定）:
  - ターン消費なし。表示は最小（名前＋短い説明＋主要タグ/状態）。
  - 敵の場合は、敵種別学習に応じて「行動傾向」「次の行動（確度つき）」などを追加表示できる。
- 補足（P0方針）:
  - コンテナ/敵などの「所持品/中身」は Inspect では表示しない（将来拡張要素）。

## 6. タグ追加/調整の DoD（チェックリスト運用）

新規タグ or ルール追加は、最低限これを満たす。

- 目的: 火力差でなく verbs（選択肢）が増える説明ができる
- 入口: 初見でも到達しやすい（現地調達/頻度/UI摩擦）
- 出口: 解除/無効化/回避があり「知らないと詰む」にならない
- 観測: 付与/効果/解除が **ログ＋エフェクト（見た目）＋AI反応**で分かる
- 再現性: 低確率偶然に依存しない（条件成立で確定する道筋）
- 組み合わせ: 例外だらけにならず、上書き/併存が単純
- 経済: 重い対策装備の複数持ちを強制しない
- AI反応: 予測可能な反応が最低1つある
- テスト: 短い手順で再現でき、期待ログが出る

（運用テンプレはチェックリストの付録をコピペして使用）

## 7. 受け入れ基準（この MVP が「足りた」と判断する条件）

**1プレイ内で次が成立していること**

1) 素材入手→投擲→分かりやすい結果（最低1回）
2) 素材×環境の変質（最低1回）
3) 宝箱からタグ付き武器が出て、試す動機が生まれる
4) 重量超過で「欲張ると不利、捨てると回復」が体感できる
5) FoW により探索が成立し、Inspect/ログで原因が追える
   - 補足: 内部タグ名や RULE ID の明示は Dev Only のデバッグ観測で行い、プレイヤー向けには自然言語で「何が起きたか」が分かることを優先する。

**さらに（質のゲート）**
- タグを使わない攻略も成立するが、使うと安全/効率/突破力で得をする
- 原因不明死・見えない判定がほぼ起きない（プレイヤー向けログ/観測で「何が起きたか」が追える。原因特定は Dev Only のデバッグ観測で補助できる）
- 1状況で考えるタグが多すぎない（最大2〜3が基本）

## 8. 実装順序（依存が少ない順）

1) ログ基盤（プレイヤー向けログ＋Dev Only デバッグ観測、状態変化、Inspect）
2) ラボ環境（スポーン/リセット/再現）
3) 最小タグ＆素材（入手→投擲→結果、素材×環境変質）
4) 重量（超過デバフ＋捨てる）
5) 宝箱 → タグ付き武器の個体生成
6) FoW（3状態）
7) ルール付きゾーン生成（seed＋保証配置）
8) AI反応（最低1つ）

## 9. 次フェーズへの接続（v0要素の取り込み方針）

この MVP の受け入れ基準を満たした後に、v0 の要素は **“圧を増やすための部品”**として段階的に取り込む。

- 死亡→リセット（テンポと緊張）
- 深さ/危険度の導入（出所が説明できる進行）
- 報酬（レアリティ色、数値加算エンチャント）

ただし、無限地上ストリーミング等の重い土台は、検証と独立なら後回し。

---

## 付録 A: あなたの新MVP案（1〜4）との対応

1. 生成（seed） → 3.2 の保証配置付きゾーン生成
2. タグ磨き込み → 6. DoD（チェックリスト運用）
3. チェストからタグ武器 → 4.4 と 2.1C
4. ログ強化 → 5. ログ/観測

上記に追加したのは、v1 が「同一プレイ内で試せること」を必須としている要素（素材ループ・重量・FoW/観測）を落とさないため。

---

## 10. 実装分割（WBS：P0/P1）と「どこまで作るか」

このセクションは、8章「実装順序」を **実際のチケット粒度に割る**ための設計メモ。  
> 前提: 現状コードには、ログ/UI（Log/HUD/Inventory）、投擲（油瓶→`overlay_oil`化）、タイルInspect（説明文）、RULE P-01/E-01 の一部などが既に存在する。  
> そのため、P0は「未実装の穴を埋めて検証ループを回す」ことに集中する。

### 10.0 決定事項（暫定・MVP方針）

> 注: ここに記載する「決定事項」は、MVPを破綻なく回すための**実装方針（暫定）**。  
- アーキ方針（MVP）:
  - `Blueprint/Provider` のような「生成/ロード分離の束ね体系」は、MVPでは導入しない（コスト過多になりやすい）。
  - ただし、MVPでの破綻回避と参照点の一元化のため、`WorldState` 相当の **薄い集約点（データの箱）**は導入する。
    - `WorldState` は「世界の現在状態」をまとめるだけで、ルール実行や生成の責務は持たない。
  - 現行パイプライン（`TurnManager` / `GameController` / `GameRoot`）を維持する（LOCKEDは触らない）。
  - Core に Unity 依存を持ち込まない（UnityIntegration 側で描画/UIを吸収する）。

- ワールド表現（最小の追加データ）:
  - `WorldState` は、少なくとも次をまとめて保持する前提にする（名前は仮）。
    - `MapState`（座標に紐づく状態）: `TileType[,]` / `Prop` / `ItemPile` / FoW記憶
    - `EntityRegistry`（動く存在）: プレイヤー / 敵 / （必要なら投射物）
    - `WorldRngState`（乱数状態）: 生成/戦利品/AI の3ストリームの RNG state（進行状態）＋ `runSeed`
      - ストリームは P0 では `GenRng` / `LootRng` / `AiRng` の 3 本で固定し、相互干渉を抑える。
      - 新しいストリーム追加は原則行わず、必要になった場合のみ「干渉を切る」目的で増やす（チケットで合意してから）。
  - `MapManager` は `TileType[,]`（地形）を維持しつつ、`MapState` の内部として **薄い追加データ**を持てる前提にする。
    - `Prop`（置物）: タイル座標 → Prop の個体データ（種類/状態など）
    - `ItemPile`（落ち物）: タイル座標 → その座標に存在するアイテム群（順序あり）
    - `Prop` の一種として「死体痕（血しぶき等）」を置けるようにする（死亡した敵の残留表現）。
      - 死体痕は、戦利品の回収状況に関わらず **3日（`3600 turns`）で消滅**する（=デカール的な残留）。
  - 原則として `Prop` と `ItemPile` は **同一マス共存禁止**。
    - ただし、万一共存してしまった場合は「描画はProp優先」「拾う判定はItemPileも対象」を許容（破綻回避用）。

- 落ち物（ItemPile）の表示ルール（CoQリファレンス）:
  - 1タイルに複数アイテムが存在し得るが、**マップ上の表示は代表スプライト1枚のみ**とする。
  - 代表スプライトは **最古（最初に落とされた）エントリ**のアイコンを固定で使う。
  - スタック可能アイテムは **同一 `itemId` を同一エントリにマージ**（数量加算）し、代表（最古）を不用意に変えない。
  - 残留期限（暫定）:
    - 敵ドロップだけでなく、**プレイヤーが地面に落としたアイテムも含め**、ワールド上の落ち物は「落とした瞬間」から **3日（`3600 turns`）で消滅**する。
    - 同一 `itemId` にマージされるスタックでも、「いつ落としたか」が異なる品を混ぜる場合があるため、実装上は「落とした時刻（turn）を保持し、期限到来ぶんから消える」形を推奨する（表示は合算してよい）。
      - 例: 内部的には `dropTurn` ごとの「バッチ（数量）」をキューで保持し、表示上は合算、代表スプライトは最古バッチで固定する。
    - コンテナ内（チェスト等）の中身は、この「3日消滅」の対象にしない（= **地面の `ItemPile` のみ**が対象）。
  - 将来拡張（MVPでは未実装）:
    - アイテム品質（風化/劣化）を導入する場合、品質差でスタックが分割され得る（＝`itemId` だけではマージできない）前提で設計する。

- ドロップ配置（置けない場合のスライド）:
  - プレイヤーのドロップ品: 原則「プレイヤー足元」。置けない場合は近傍へスライド。
  - 敵のドロップ（死体/戦利品等）: 原則「死亡したタイル」。置けない場合は近傍へスライド。
  - 近傍スライドの探索順（固定）: 足元 → N → NE → E → SE → S → SW → W → NW

- 行動コスト（MVP）:
  - `拾う` / `装備する` / `インタラクト`（Prop操作）: **1アクション=100TU（1ターン）**で固定。
  - `話す`: 隣接8方向のみ（ターン消費の有無は別途扱う）。

- アイコン解決（fail-fast）:
  - 落ち物表示に使うアイコンは、**インベントリのアイコンと同一**でよい。
  - アイコンが解決できない状態は「起きない前提」ではなく**バグとして検知**する（フォールバックは置かない）。
  - 目的: 「見えない落ち物」を作らず、検証の信頼性を守る。

- AI（MVP: 予測可能性を優先）:
  - 実行経路: 敵AIの移動/攻撃などは **必ず `ActionSystem` 経由**に統一し、`SetPosition` 等によるバイパスを禁止する。
  - 知覚: 「知っている（ターゲット保持/追跡）」と「攻撃できる（LOS要件）」を分離する。
    - 攻撃（特に射撃/能力など）を候補に入れる条件として `HasLOS(target)` を要求する（遮蔽物越しに撃たない）。
  - 記憶/追跡（短期）:
    - `lastSeenPos` を保持し、見失っても **15ターン**は追跡対象として維持する。
    - 見失ったら `lastSeenPos` へ移動し、到達後は **最大10ターン**だけ周辺探索する（見つからなければ追跡を打ち切る）。
  - 逃走（Self-preservation）:
    - 開始: `HP% <= 0.10` で `Fleeing` に入り、行動優先度は最上位とする。
    - 逃走中: ターゲット（見えていれば現在位置、見えていなければ `lastSeenPos`）から距離が増える移動を最優先する。移動不能なら戦闘を選ぶ。
    - 終了: `HP% >= 0.70` で `Fleeing` を解除し、以後は通常の戦闘ロジックへ戻り得る。
  - 同点処理（初期値）:
    - `topN=2` / `tieWindow=2`（同ティア内の上位を僅差扱い）とし、同点（または僅差）だけタイブレークで揺らす（乱数はタイブレーク専用）。
    - `backtrackPenalty=1`: 直前ターンの位置（`prevPos`）へ戻る移動候補に小さな減点を入れ、左右に揺れる往復ループを抑える。
  - ゲーム内時間スケール（暫定）:
    - `1 hour = 50 turns`（= 12 hours: 600 turns / 1 day(24h): 1200 turns）
    - 中立の「忘却 3日」は `3600 turns` とする。
  - 敵対/忘却（中立の一時敵対）:
    - 中立が一時敵対した場合、忘却カウントは **視界外でのみ進行**し、対象が視界内に入ったら **リセット**する。

### 10.0.1 合意済み（調整前提の詳細）

> ここは「合意済みだが、暫定値や実装詳細を含むため、プレイ結果で調整し得る」項目。

- EffectSystem（肥大化対策）:
  - 目的: E-02/E-03/延焼/消火などを追加しても、`EffectSystem` が if の寄せ集めになって破綻しないようにする。
  - 方針（暫定・合意）:
    - `EffectSystem` はフェーズ入口（投射物/環境/状態異常）の **ファサード**として残す。
    - 事象（例: 火/水/電気）は `FireModule` 等の **Module** として定義し、事象固有の状態と操作API（Ignite/Extinguish/Tick/Candidates 等）を保持する。
    - 事象×事象の相互作用は **RULE ID 単位の Rule クラス**に寄せる（例: `RuleE01`, `RuleE02`, `RuleE03`, `RuleP01`, `RuleWetBurningExtinguish`）。
      - Rule は「条件/優先度/順序/ログ（RULE ID）」の決定を担い、低レベルな書き換えは原則 Module の操作APIへ委譲する（Ruleの肥大化を防ぐ）。
    - 依存（循環）防止:
      - Module 同士が直接参照しない（`FireModule -> WaterModule` 等を禁止）。
      - Rule は Module を参照してよいが、Module は Rule を参照しない。
  - 実装上の分割粒度:
    - まずは `partial class EffectSystem`＋少数ファイル（`EffectSystem.cs`＋`EffectSystem.Fire.cs` 等）で開始し、
      1ファイルが肥大化（目安 300行）した場合にのみ、RULE/事象単位で追加分割する。
  - 火の延焼（暫定・MVP）:
    - `flammable`（例: 木）: 4近傍で **連続3ターン**隣接すると点火。
    - `oily`（油）: 8近傍で **1ターン**隣接すると引火し、8近傍に 1ターンごとに伝播。
    - 油由来の `fire_tile` は 3ターンで `ground_burnt` へ。`ground_burnt` は 3600ターン（3日）で `ground_normal` に戻る（RULE E-04）。
    - `tree_burnt` は 3600ターン（3日）で撤去され `ground_burnt` に置換される（暫定）。

- FoW視界半径: **8タイル**
- FoW遮蔽: `blocking` を遮蔽物として扱う（視界計算で遮る）
- FoW表示:
  - 未探索: 真っ黒
  - 探索済み視界外: **地形（床/壁/木/固定プロップ等）だけ**保持して薄暗く表示し、動的要素（敵/落ちアイテム等）は隠す
  - 視界内: 通常表示
- 重量（carry）:
  - 最大重量（初期）: **30kg**
  - ソフト超過: **最大重量の +20% まで**（<= 36kg）
  - ハード超過: **36kg を超える**
  - ドロップ（捨てる）は **常に可能**（行動不能状態でも例外で許可する）
 - コンテナ（チェスト/机/ドレッサー等）:
  - P0で **簡易コンテナUI**を実装し、チェスト以外のプロップにも再利用できる形にする
  - アニメーションは不要。UIは最小でよい（中身リスト＋取り出す/しまう）。
  - 中身は **Open 時に 1 回だけロールして確定**し、以後は固定（Open/Close はターン消費なし）
    - コンテナは `lootSeed` を持ち、ロールは `lootSeed` に基づき決定的に行う（将来テーブル差分へ接続できる形を推奨）
      - `lootSeed` は「このコンテナ固有の乱数源」を表す値で、同一 run 内で **開ける順番に依存しない** ことを重視する。
      - 推奨: 生成時に `runSeed` と座標（＋コンテナ種別ID等）から `lootSeed` を決定し、Prop状態として保持する（セーブ/ロード時も保持）。
      - ロールは `lootSeed` から初期化したローカルRNG（またはハッシュ）で行い、`WorldRngState.LootRng` の消費順に依存させない（再現性・デバッグ性を優先）。
    - コンテナ内の中身は、地面 `ItemPile` の「3日消滅」対象にしない（=保管物は消えない）。
  - 敵ドロップ（順序非依存）:
    - 敵の戦利品/ドロップは「倒す順番に依存しない」ことを優先し、各敵個体が `dropSeed` を保持する（個体ごと固定）。
    - 推奨: スポーン時に `runSeed` と座標（＋spawnIndex等）から `dropSeed` を導出し、エンティティ状態として保持する（セーブ/ロード時も保持）。
    - ドロップロールは `dropSeed` から初期化したローカルRNG（またはハッシュ）で行い、`WorldRngState.LootRng` の消費順に依存させない。
  - ターン整合（invariants遵守）:
    - 「開く/閉じる」はターン消費なしでよい
    - 「取り出す/しまう」は **1操作=1ターン（100TU）**で必ずターン進行を経由する
- Inspect:
  - 表示: スプライト / 説明文 / タグ（タグの意味はツールチップ等で確認）
  - P0では中身/所持品は表示しない（将来拡張要素）

- コンテキストメニュー（右クリック）:
  - 不可能な項目は「無効表示」ではなく**非表示（hide）**を基本とする（メニュー肥大化を避ける）。
  - 代表項目（例）:
    - `拾う`（到達範囲内＋対象タイルに `ItemPile` があるとき）
      - 押下で「そのタイルのアイテム名リスト」を表示（常にリスト）
      - リスト: 左クリックで `拾う`、右クリックで「アイテムのコンテキスト（例: 装備/調べる）」へ
    - `装備する` は「拾うリスト内」から実行（装備可能なアイテムのみ）。
    - `狙う`（射撃ロックオン）／射撃モード切替（狙い撃ち）は別途導線として用意する（射程外は非表示）。
    - `調べる` は距離制限なし。ただし未探索（真っ黒）マスは対象にできない（探索済み/視界内は可）。

### 10.1 ① ログ基盤（RULE ID / 状態変化 / Inspect）

- ゴール: 「何が起きたか」「なぜ起きたか（RULE）」がログで追え、Inspect で再確認できる。
- P0（最小）:
  - 既存ログを維持しつつ、**状態変化のログ**を増やす（例: タイルが別タイルへ遷移、状態異常が付与/解除）。
  - 既存のタイル「調べる」を拡張し、Inspect情報（説明文/タグ枠）を表示できる。
    - タグの意味はツールチップ等で確認できる形を想定する。
  - ホバー/ターゲット（ミニInspect）を追加し、戦闘/探索中に「見るだけ」を低摩擦にする（ターン消費なし）。
  - 敵種別の学習（最小）:
    - 敵を観測/戦闘するほど、ミニInspect/Inspect の情報が整理される（行動傾向、次の行動の確度表示など）。
    - 閾値や確度の上がり方はプレイテストで調整する（まずは 3 段階: 低/中/高 を想定）。
  - 重要ログは最低限 **RULE ID を文面に含む**（既に P-01/E-01 は対応済み。未対応分を埋める）。
- P1（拡張）:
  - （任意/Dev Only）初回発火の内部計測（RULE ID 単位で一度だけ）
    - ただしログに「発見」を明示する文言（`DISCOVERED:` 等）は出さない。
  - 「原因→結果」を構造化して保持（後でリプレイ/学習に繋げられる形）。
- 依存: なし（既存ログ・Inspect の延長）。
- 検証（DoD目安）:
  - 代表的な相互作用（火×木、油引火、火傷）が、ログとInspectだけで追える。
- アセット: 追加なし（UIは文字ベースで可）。

### 10.2 ② ラボ環境（スポーン/リセット/再現）

- ゴール: タグ/RULE/素材相互作用を **短手順で再現**し、調整ループを高速に回す。
- 方針（MVP）:
  - **Lab と Discovery はシーンを分ける**（デバッグ機能が実プレイ検証を汚染しないようにする）。
    - Lab: 固定プリセット＋再現/回帰/検証導線に特化（本節）。
    - Discovery: seed＋保証配置で「実プレイの感触」を検証（10.7以降）。
- P0（最小）:
  - **固定プリセット**で開始する（毎回同じ配置・同じ初期状態）。
  - リセット（初期レイアウトへ戻す）を 1 操作で実行できる。
  - 代表ケースの再現プリセットを同一マップ内に配置する（例）:
    - 油だまり＋火源＋木（延焼/燃え尽き/焼け跡回復の検証）
    - 火傷確認用の `fire_tile`（RULE E-03）
  - RNG（チェスト/敵ドロップ）の回帰検証ができる配置を用意する:
    - チェストA/B: それぞれ固定の `lootSeed` を持つ（Open時に1回だけロールして確定）。
    - 敵A/B: それぞれ固定の `dropSeed` を持つ（倒す順番に依存しない）。
    - 検証: 「開ける/倒す順序」を入れ替えても結果が一致する（順序非依存）。
- P1（拡張）:
  - デバッグUIから、タイル/アイテム/敵を任意座標へスポーンできる。
  - チェストの `lootSeed` / 敵の `dropSeed` を表示し、結果（中身/ドロップ）もログまたはUIで確認できる。
- 依存: ①（ログ/Inspectがあると調整が速い）。
- 検証（DoD目安）:
  - 5分以内に「油引火→延焼→火傷」まで再現できる。
  - チェスト/敵ドロップが「順序非依存」で再現できる。
- アセット: 追加なし（ボタン/テキストで可）。

### 10.3 ③ 最小タグ＆素材（入手→投擲→結果、素材×環境変質）

- ゴール: タグ/素材/環境相互作用が「義務ではないが、使うと得」になる入口を作る。
- P0（最小）:
  - MVP範囲 RULE を優先して穴埋め:
    - RULE E-02（火×油: 引火＆伝播）
    - RULE E-03（火×エンティティ: 火傷付与）
  - 素材の入口は **既存の油瓶/土くれ**を土台にしてよい（現状: 油瓶は地形変化あり、土くれはフレーバーのみ）。
  - 「再現性（条件成立で確定）」を優先し、確率に依存させない。
- P1（拡張）:
  - 土くれ投擲に「分かりやすい結果」を付ける（遮蔽/足止め等）
  - 「水」系（濡らす/消火など）を追加する場合は、既存タグ `wet` を使い **新ルールの追加有無**を先に確定する。
- 依存: ①（ログ/Inspectで原因追跡）＋②（ラボで再現）。
- 検証（DoD目安）:
  - 1プレイ内で「素材→結果」「素材×環境→変質」を各1回以上、狙って起こせる。
- アセット:
  - 既存流用が基本（油だまり・火・木・敵/プレイヤー・油瓶/土くれアイコン）。
  - P1で「水を運ぶ/投げる」を入れるなら、関連アイコンが追加で必要になりうる（11章参照）。

### 10.4 ④ 重量（ソフト制限）＋逃げ道

- ゴール: 「拾う→試す→選ぶ」が成立し、欲張り/撤退の判断が生まれる。
- 注意: MVPは **基本行動コスト=100TU固定**。重量でTUコストを直接いじる設計は、別途仕様更新が必要。
- P0（最小）:
  - アイテムに weight を持たせ、インベントリの **総重量**を計算できる。
  - 閾値（暫定）:
    - 最大重量（初期） `W = 30kg`
    - ソフト超過（encumbered）: `W < total <= 1.2W`（<= 36kg）
    - ハード超過（immobile）: `total > 1.2W`（> 36kg）
  - ソフト超過時の挙動:
    - 何らかの不利益が発生する（例: 視界半径の減少、戦闘ステータス低下など）。
    - P0では「体感が出て実装が軽い」不利益を 1 つに固定する（※候補は後述）。
  - ハード超過時の挙動:
    - 原則として行動不能（移動/攻撃/投擲/射撃/使用などを禁止する）。
    - **ただしドロップ（捨てる）は常に可能**とし、詰みを回避する。
  - ドロップ（捨てる）で即回復できる導線がある（既存UIの「捨てる」を流用可能）。
  - 逃げ道は P0 では「迂回できる通路」で担保し、出口タイルの追加は後回しでよい。
- P1（拡張）:
  - ソフト制限の不利益を強化（例: 視界半径の減少、戦闘ステータス低下など）。※どれを採用するかは先に仕様化する。
  - 出口/退避タイル（階段等）を追加して「撤退」を明確化。
- 依存: ⑤（拾う/捨てる/配置が安定すると判断が回る）＋⑥（FoWがあると撤退判断が成立しやすい）。
- 検証（DoD目安）:
  - 同一プレイ内で「欲張ると不利、捨てると回復」が体感できる。
- アセット:
  - P0: 追加なし（UIは数値表示のみで可）。
  - P1: 重量/超過状態を示すUIアイコンを追加したくなる可能性あり。

### 10.5 ⑤ 宝箱 → タグ付き武器の個体生成

- ゴール: 「拾う→試す→選ぶ」の“試す”側（武器の差分）に動機を作る。
- P0（最小）:
  - チェストは「コンテナ（中身を持つプロップ）」として扱い、P0で簡易コンテナUIを実装して開けられるようにする（机/ドレッサー等にも流用できる設計）。
    - アニメーションは不要。UIは「中身リスト＋取り出す/しまう」で十分。
    - ターン整合: 取り出す/しまうは **1操作=1ターン（100TU）**で必ずターン進行する。
    - 中身は **Open 時に 1 回だけロールして確定**し、以後固定とする。
      - チェスト（コンテナ）は `lootSeed` を持ち、ロールは `lootSeed` に基づき決定的に行う。
      - P0では中身の事前表示は行わない（Inspectでは中身を見せない）。
  - 配置（暫定）:
    - 1個は必ず配置（保証）。
    - 追加分は「キャンプ寄り70% / 跡地寄り30%」で配置（seedで決定）。
  - 武器は 1種でよいが、「火力差」ではなく **状況操作の手段**として差分が分かることを優先する。
- P1（拡張）:
  - コンテナ種別（樽/棚/机など）を増やし、スポットの意味付けを強化する。
  - `chest_normal` 等の見た目と「空表示」など、最小の視覚差分を足す（必要なら別チケット化）。
  - 2〜3個の“タグ付き武器”を追加し、プレイ内で更新が起きる確率を上げる。
- 依存: ③（タグ/素材が機能している）＋④（重量で選択が生まれる）。
- 検証（DoD目安）:
  - 宝箱相当の報酬で武器を入手し、「試す理由」がログ/状況で生まれる。
- アセット:
  - P0: 既存の武器アイコン・`chest_normal` の流用で開始可能。
  - P1: `chest_rare`、開封差分などが欲しくなる（11章参照）。

### 10.6 ⑥ FoW（3状態）

- ゴール: 3状態 FoW を満たし、「未知」が成立する。
- P0（最小）:
  - 未探索/探索済み視界外/視界内 の 3状態を表示できる。
  - 視界半径は **8タイル**（暫定）とする。
  - 遮蔽（`blocking`）を考慮した視界計算を行う（視界を壁で遮る）。
  - 視界外では **動的要素（敵/落ちアイテム等）を表示しない**（地形だけ残す）。
- P1（拡張）:
  - 視界計算の最適化（タイル数が増えた場合に備える）。
  - 視界内外の切り替えが分かりやすい演出（明度差、軽いフェード等）。
- 依存: なし（ただし④/⑤の意思決定を強化する）。
- 検証（DoD目安）:
  - 探索の結果として「情報が残る/消える」が意図どおりに起きる。
- アセット: 追加なし（色/明度で表現可能）。

### 10.7 ⑦ ルール付きゾーン生成（seed＋保証配置）

- ゴール: `3.2` の保証配置を満たすゾーンを、seedで決定的に生成できる。
- P0（最小）:
  - seed入力（数値）で同じゾーンが再現される（デバッグ用でOK）。
  - 保証配置だけは **確実**に満たす（木/水辺/キャンプ/建物跡地/チェスト/入口/退路）。
  - 生成は「それっぽさ」より「試せる」を優先し、P0では **スタンプ（テンプレ）＋seedで揺らす**方式を採用する。
      - スタンプ（例）:
      - `PondStamp`: 水辺（`overlay_water`）の塊
      - `GroveStamp`: 木（`tree_normal`）の塊（通路を1本は通す）
      - `RuinsPerimeterStamp`: 「外周壁だけ」の建物跡地
        - 実装方針: 矩形の外周だけ `wall_*` を配置し、外周の一部を欠損（穴/崩落）させて“跡地”感を出す
      - `CampStamp`: 火源（焚き火相当）＋敵スポーン位置
      - `EntranceStamp`: ダンジョン入口（下り階段）
  - チェスト配置（暫定ルール）:
    - 1個は必ず配置する（保証）。
    - 追加分は「キャンプの火源付近」または「建物跡地の内側」に配置する。
      - 確率（暫定）: キャンプ寄り 70% / 跡地寄り 30%（seedで決定）
  - 接続性の保証（必須）:
    - 「開始地点→各ランドマーク→入口」が歩行可能タイルで到達できることを検証し、失敗したら配置を再試行する。
    - P0は“迷路生成”より、通路を明示的に掘って接続する方針でよい（確実性優先）。
- P1（拡張）:
  - CoQ風に寄せた偏り/テーマ付け（スポットの意味付け）。
  - 生成の揺らぎ（敵配置や宝箱中身）を増やす。
- 依存: ②（ラボがあると調整が速い）＋⑥（FoWがあると探索になる）。
- 検証（DoD目安）:
  - seedをメモすれば、同じ状況をすぐ再現できる。
- アセット: P0は既存タイルで十分。P1でバイオームを増やす場合は追加。

### 10.8 ⑧ AI反応（最低1つ）

- ゴール: タグが“義務”ではなく“得”になるよう、敵側にも最低限の反応を持たせる。
- 補足: プレイヤー向けにはタグ/ルールを説明しすぎないため、AI反応も「何が起きているか」を理解する手がかりとして機能させる（ログ＋エフェクト＋AI反応）。
- P0（最小）:
  - モンスターキャンプ（焚き火）を成立させる:
    - キャンプの敵は「火源の周囲で待機（巡回半径を小さく）」することで“集っている”雰囲気を作る（高度な会話/儀式はP1以降）。
  - 予測可能な反応を最低1つ入れる（例）:
    - `hazardous`（火など）を避ける（踏まない/経路選択で避ける）
    - `burning` 中の鎮火（結果だけログ）:
      - `wet` タイル（例: 水たまり）へ侵入した瞬間に鎮火する（即時）。
      - ログ例: 「ゴブリンは水たまりに飛び込み、鎮火した！」
- P1（拡張）:
  - `burning` 中の退避行動:
    - 近くに水辺（`wet`）があれば、そこへ移動して火を消そうとする（※消火仕様は別途定義）
  - 油だまりを避ける/回り込む、火源から距離を取る等のバリエーション。
- 依存: ③（hazardous/burning 等が機能している）＋⑥（FoWで見えない敵の理不尽を避ける）。
- 検証（DoD目安）:
  - プレイヤーが「誘導/罠/地形利用」で得をでき、ログ＋エフェクト＋AI反応で納得できる。
- アセット: 追加なし。

---

## 11. アセット逆算（Discovery MVP：最小セット）

ここでは「Discovery MVP を回すのに最低限、何枚のアセットが要るか」を逆算する。  
### 11.1 まずは “既存で足りている” もの（P0想定）

- タイル（環境）: `ground_*`（通常/水/油/焼け）、`tree_*`、`fire_tile`、`wall_*`
- 置物（最低限）: `chest_normal`
- キャラ: プレイヤー1体、敵1〜2体（既存スプライトを流用）
- アイテムアイコン: 弓/剣/盾/矢、油瓶、土くれ、Artifact（既存を流用）

### 11.2 追加が発生しやすいもの（P0で必要になったら作る）

| 用途 | 最小追加数（目安） | 例（仮ID/仮名） | 備考 |
|---|---:|---|---|
| 恒常ツール（着火の起点） | 1 | 火打ち石アイコン | アイテムとして扱う（捨てる/投げる可、重量0）。紛失しても再入手可能にする前提。 |
| 恒常ツール（液体の起点） | 1 | 空の容器アイコン | アイテムとして扱う（捨てる/投げる可、重量0）。中身（液体量）で重量が変動する設計に繋げやすい。 |
| 液体の中身（例: 水） | 1 | 水入り容器アイコン | ③の拡張で“水を運ぶ”を採用する場合。 |

### 11.3 P1以降で欲しくなるもの（後回しでOK）

| 用途 | 目安 | 備考 |
|---|---:|---|
| 宝箱差分 | 1〜3 | `chest_rare` / 開封後など（識別性優先）。 |
| 状態/重量UIアイコン | 0〜3 | 超過状態・デバフの可視化（文字だけで足りるなら不要）。 |
| 追加エフェクト | 0〜数枚 | 油引火/延焼/火傷の“瞬間”が分かりにくい場合のみ。 |
| 付着/濡れの視覚表現 | 0〜数枚 | `oily`/`wet` などを色点滅や軽いオーバーレイで表現できない場合のみ。 |
